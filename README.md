# 明日方舟·终末地 抽卡概率模拟器

<div align="center">

[![Python Version](https://img.shields.io/badge/python-3.8%2B-blue)](https://www.python.org/)
[![License](https://img.shields.io/badge/license-MIT-green)](LICENSE)
[![Platform](https://img.shields.io/badge/platform-Windows%20%7C%20Linux%20%7C%20macOS-lightgrey)](https://github.com)

一个功能完善的明日方舟·终末地抽卡概率模拟器，支持角色池和武器池联合模拟，提供图形化界面和详细的统计分析。

[功能特性](#-功能特性) • [快速开始](#-快速开始) • [使用说明](#-使用说明) • [打包发布](#-打包发布) • [项目结构](#-项目结构)

</div>

---

## ✨ 功能特性

### 🎮 完整的抽卡模拟系统

- **角色池模拟**
  - ✅ 小保底/大保底/循环保底机制
  - ✅ 概率提升区间（区间式软保底）
  - ✅ 免费十连和紧急招募支持
  - ✅ 5星保底机制（10抽内必得5星或以上）
  - ✅ 武器配额累积系统

- **武器池模拟**
  - ✅ 武器池十连抽卡（配额消耗机制）
  - ✅ 特殊奖励节点（第10次、第18次及后续循环）
  - ✅ 额外配额购买机制
  - ✅ 低配额角色池控制策略

- **联合模拟策略**
  - ✅ 角色池与武器池联动策略
  - ✅ 自定义抽卡目标（限定角色/限定武器数量）
  - ✅ 抽卡次数上限和下限控制
  - ✅ 灵活的策略配置

### 🖥️ 图形化用户界面

- ✅ 清晰直观的Tkinter GUI界面
- ✅ 实时参数配置和验证
- ✅ 进度显示和结果展示
- ✅ 无需编程知识即可使用

### 📊 强大的统计分析

- ✅ 成功率统计和失败原因分析
- ✅ 抽数分布累积概率曲线（CDF）
- ✅ 堆叠柱状图展示成功/失败分布
- ✅ 武库配额使用统计
- ✅ 高质量PNG图表输出

### 📦 一键打包部署

- ✅ 提供自动化打包脚本
- ✅ 生成独立可执行文件（.exe）
- ✅ 无需Python环境即可运行
- ✅ 支持单文件和文件夹两种打包模式

---

## 🚀 快速开始

### 方式一：直接运行（需要Python环境）

#### 1. 环境要求

- Python 3.8 或更高版本
- Windows / Linux / macOS

#### 2. 安装依赖

```bash
pip install numpy matplotlib scipy
```

#### 3. 运行程序

```bash
python ui_main.py
```

### 方式二：使用可执行文件（无需Python）

#### 下载已打包的exe文件

直接双击运行 `明日方舟终末地抽卡模拟器.exe`（如果有发布版本）

#### 自己打包

1. 双击运行 `build.bat`
2. 等待打包完成（约2-5分钟）
3. 在 `dist` 文件夹中找到生成的 `.exe` 文件

详见 [打包发布](#-打包发布) 章节。

---

## 📖 使用说明

### GUI界面使用

1. **配置角色池状态**
   - 输入已使用的抽数
   - 勾选是否已获得限定角色
   - 设置保底信息

2. **配置武器池状态**
   - 输入已使用的十连次数
   - 设置初始武器配额

3. **设置抽卡目标**
   - 设置需要获得的限定角色数量
   - 设置需要获得的限定武器数量

4. **配置抽卡策略**
   - 设置角色池抽卡次数上限
   - 设置角色池最少抽卡次数
   - 设置武器池抽卡次数上限
   - 设置武器池最少抽卡次数
   - 配置低配额时角色池策略

5. **运行模拟**
   - 设置模拟次数（建议1000-10000次）
   - 点击"开始模拟"按钮
   - 等待模拟完成

6. **查看结果**
   - 查看成功率和统计信息
   - 查看生成的PNG图表文件

### 统计结果说明

模拟完成后会显示：
- **成功率**：达成目标的模拟次数占比
- **角色池抽数统计**：平均值、最小值、最大值、中位数
- **武器池十连次数统计**：平均值、最小值、最大值、中位数
- **剩余武库配额统计**：模拟结束后剩余配额分布
- **额外购买配额统计**：需要额外购买的配额分布
- **失败原因统计**：各种失败原因的占比

### 生成的图表

程序会在运行目录生成以下PNG图片：

1. **combined_success_failure_pie.png**
   - 成功率饼图
   - 剩余配额分布
   - 额外购买配额分布

2. **combined_all_cdf.png**
   - 角色池抽数累积分布曲线
   - 角色池成功/失败堆叠柱状图
   - 武器池十连次数累积分布曲线
   - 武器池成功/失败堆叠柱状图

---

## 📦 打包发布

### 快速打包

**只需双击运行 `build.bat`！**

脚本会自动完成：
1. ✅ 检查并安装 PyInstaller
2. ✅ 清理旧的打包文件
3. ✅ 打包成单个可执行文件
4. ✅ 打开生成的文件夹

生成的 `明日方舟终末地抽卡模拟器.exe` 可以：
- 在任何Windows电脑上运行
- 无需安装Python环境
- 无需安装任何依赖库
- 独立完整运行

### 打包选项

#### 单文件模式（推荐分发）
```bash
build.bat
```
生成单个exe文件，方便分发，但首次启动稍慢。

#### 文件夹模式（启动更快）
```bash
build_advanced.bat
```
生成包含多个文件的文件夹，启动更快，但需要分发整个文件夹。

### 详细说明

查看 [打包说明.md](打包说明.md) 了解更多打包选项和常见问题。

---

## 📁 项目结构

```
明日方舟终末地抽卡模拟器/
├── ui_main.py                   # 图形界面主程序 ⭐ 启动入口
├── config.py                    # 配置模块 - 数据结构定义
├── character_gacha_utils.py     # 角色池抽卡逻辑
├── weapon_gacha_utils.py        # 武器池抽卡逻辑
├── analysis_utils.py            # 统计分析和可视化
├── character_weapon_main.py     # 命令行版联合模拟（旧版）
│
├── build.bat                    # 一键打包脚本（单文件）
├── build_advanced.bat           # 高级打包脚本（文件夹）
├── 打包说明.md                   # 详细打包文档
├── requirements_build.txt       # 打包依赖列表
│
└── README.md                    # 本文件
```

---

## 🔧 核心模块说明

### config.py - 配置模块

定义了多个核心数据类，清晰地分离了不同类型的数据。

#### 主要数据类

| 数据类 | 说明 |
|--------|------|
| `CharacterPoolConfig` | 角色池规则配置（保底、概率、武器配额等） |
| `WeaponPoolConfig` | 武器池规则配置（概率、配额消耗、特殊奖励等） |
| `PlayerInfo` | 玩家状态和目标（角色池/武器池进度、抽卡目标等） |
| `CharacterRuntimeInfo` | 角色池运行时信息（单次模拟临时状态） |
| `WeaponRuntimeInfo` | 武器池运行时信息（单次模拟临时状态） |
| `SimulationConfig` | 模拟配置（模拟次数等） |

### character_gacha_utils.py - 角色池逻辑

实现角色池的所有抽卡逻辑：
- 概率计算和区间式软保底
- 小保底/大保底/循环保底机制
- 5星保底机制
- 免费十连和紧急招募
- 武器配额累积

### weapon_gacha_utils.py - 武器池逻辑

实现武器池的所有抽卡逻辑：
- 纯概率抽取（4%出六星）
- 配额消耗机制（1980/十连）
- 特殊奖励节点（第10/18次及循环）
- 额外配额购买
- 与角色池的联动模拟

### analysis_utils.py - 统计分析

提供统计分析和可视化功能：
- 使用非交互式后端（Agg），避免线程冲突
- 生成高质量PNG图表
- 累积分布曲线（CDF）
- 堆叠柱状图
- 饼图统计

### ui_main.py - 图形界面 ⭐

Tkinter图形用户界面：
- 直观的参数配置
- 实时输入验证
- 后台线程运行模拟
- 进度显示和结果展示

---

## 🎯 游戏机制说明

### 角色池机制

- **基础概率**
  - 4星：50%
  - 5星：40%
  - 6星：1%

- **保底机制**
  - 小保底：80抽必出6星
  - 大保底：130抽必出限定6星
  - 循环保底：每200抽额外赠送1个限定

- **软保底（概率提升）**
  - 1-59抽：1%基础概率
  - 60-79抽：逐渐提升至100%

- **5星保底**
  - 每10抽内必得至少1个5星或以上

- **武器配额**
  - 4星：+100配额
  - 5星：+350配额
  - 6星：+1200配额

### 武器池机制

- **基础概率**
  - 6星武器：4%
  - 限定武器UP：25%（在6星中）

- **配额消耗**
  - 每次十连：1980配额

- **特殊奖励**
  - 第10次十连：获得补充武库箱
  - 第18次十连：赠送1个限定武器
  - 之后每8次：交替赠送补充武库箱/限定武器

- **额外购买**
  - 配额不足时可额外购买（每次1980）

---

## 💡 使用技巧

### 模拟次数建议

- **快速测试**：100-1000次（1秒内完成）
- **常规分析**：1000-5000次（数秒完成）
- **精确分析**：10000-50000次（可能需要数十秒）

### 策略配置建议

1. **保守策略**
   - 设置较高的角色池抽卡上限
   - 设置较低的武器池抽卡上限
   - 适合优先保证角色获取

2. **平衡策略**
   - 根据当前配额合理分配
   - 设置适中的上下限
   - 适合追求整体性价比

3. **激进策略**
   - 较低的角色池抽卡上限
   - 较高的武器池抽卡上限
   - 适合配额充足时冲武器

### 结果分析

- 关注**成功率**和**失败原因**，调整策略
- 查看**抽数分布**，了解资源需求
- 分析**配额使用**，优化抽卡计划

---

## 🛠️ 开发者指南

### 代码特点

- ✅ 模块化设计，职责清晰
- ✅ 函数式编程，无全局变量
- ✅ 完整的类型提示
- ✅ 命名规范统一
- ✅ 易于扩展和维护

### 扩展示例

#### 修改角色池概率

```python
# config.py
character_pool_config = CharacterPoolConfig(
    base_six_probability=0.02,  # 修改为2%
    soft_pity=70,                # 修改小保底为70抽
)
```

#### 添加新角色

```python
# config.py 中的 CharacterPoolConfig.six_star_pool
six_star_pool: Dict[str, float] = field(default_factory=lambda: {
    "限定": 1.0 / 2.0,
    "新角色": 1.0 / 14.0,  # 添加新角色
    # ... 其他角色
})
```

#### 自定义统计指标

在 `analysis_utils.py` 中添加新的分析函数即可。

---

## 🐛 常见问题

### 程序无法启动

- 检查Python版本（需要3.8+）
- 确认已安装所有依赖
- 查看错误提示信息

### 图表显示问题

- 程序已使用非交互式后端（Agg）
- 图表会保存为PNG文件
- 不会弹出显示窗口

### 打包后运行出错

- 在另一台电脑上测试
- 检查是否缺少系统字体
- 查看打包说明文档

### 模拟速度慢

- 减少模拟次数
- 使用更快的电脑
- 关闭其他占用CPU的程序

---

## 📄 许可证

MIT License - 自由使用、修改和分发

---

## 🤝 贡献

欢迎提交Issue和Pull Request！

---

## 📧 联系方式

如有问题或建议，请通过GitHub Issues联系。

---

<div align="center">

**⭐ 如果这个项目对你有帮助，请给个Star！**

Made with ❤️ for Arknights: Endfield

</div>
